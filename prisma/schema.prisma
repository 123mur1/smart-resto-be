generator client {
  provider = "prisma-client-js"
  //output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------
// USERS
// ---------------------------------------------
model User {
  user_id    String   @id @default(uuid())
  first_name String?  @db.VarChar(100)
  last_name  String?  @db.VarChar(100)
  email      String   @unique @db.VarChar(150)
  phone      String?  @unique @db.VarChar(20)
  password   String   @db.VarChar(255)
  role       Role     @default(STUDENTS)
  isverified Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  student Student?

  Otp Otp?
}

model Otp{
  otp_id      String   @id @default(uuid())
  user_id     String @unique
  code        String   @db.VarChar(10)
  expires_at  DateTime
  created_at  DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [user_id] , onDelete: Cascade)
}

// ---------------------------------------------
// STUDENTS
// ---------------------------------------------
model Student {
  student_id      String     @id @default(uuid())
  user_id         String     @unique
  registration_no String     @unique @db.VarChar(50)
  faculty         String?    @db.VarChar(100)
  meal_status     MealStatus @default(ACTIVE)
  balance         Decimal    @default(0.00) @db.Decimal(10, 2)
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  // Relations
  user           User            @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  mealAccessLogs MealAccessLog[]
  payments       Payment[]
  transactions   Transaction[]
}

// ---------------------------------------------
// MEALS
// ---------------------------------------------
model Meal {
  meal_id    String   @id @default(uuid())
  meal_type  MealType
  // meal_date  DateTime
  time_slot  TimeSlot
  price      Decimal  @default(0.00) @db.Decimal(10, 2)
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  // Relations
  mealAccessLogs MealAccessLog[]
  transactions   Transaction[]
}

// ---------------------------------------------
// MEAL ACCESS LOGS
// ---------------------------------------------
model MealAccessLog {
  log_id      String       @id @default(uuid())
  student_id  String
  meal_id     String
  access_time DateTime     @default(now())
  status      AccessStatus @default(VALID)

  // Relations
  student Student @relation(fields: [student_id], references: [student_id], onDelete: Cascade)
  meal    Meal    @relation(fields: [meal_id], references: [meal_id], onDelete: Cascade)
}

// ---------------------------------------------
// PAYMENTS
// ---------------------------------------------
model Payment {
  payment_id   String        @id @default(uuid())
  student_id   String
  amount       Decimal       @db.Decimal(10, 2)
  method       PaymentMethod
  payment_date DateTime      @default(now())
  status       PaymentStatus @default(PENDING)
  updated_at   DateTime      @updatedAt

  // Relations
  student      Student       @relation(fields: [student_id], references: [student_id], onDelete: Cascade)
  transactions Transaction[]
}

// ---------------------------------------------
// TRANSACTIONS
// ---------------------------------------------
model Transaction {
  transaction_id   String   @id @default(uuid())
  student_id       String
  meal_id          String?
  payment_id       String?
  //transaction_type TransactionType
  amount           Decimal  @db.Decimal(10, 2)
  balance_after    Decimal? @db.Decimal(10, 2)
  transaction_date DateTime @default(now())
  remarks          String?

  // Relations
  student Student  @relation(fields: [student_id], references: [student_id], onDelete: Cascade)
  meal    Meal?    @relation(fields: [meal_id], references: [meal_id], onDelete: Cascade)
  payment Payment? @relation(fields: [payment_id], references: [payment_id], onDelete: Cascade)
}

// ---------------------------------------------
// ENUMS
// ---------------------------------------------
enum Role {
  STUDENTS
  STAFF
  SUPERADMIN
  ADMIN
}

enum MealStatus {
  ACTIVE
  INACTIVE
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
}

enum TimeSlot {
  MORNING
  AFTERNOON
  EVENING
}

enum AccessStatus {
  VALID
  INVALID
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  CARD
  BANK_TRANSIFER
}

enum PaymentStatus {
  PENDING
  COMPLITED
  FAILED
}

// enum TransactionType {
//   DEBT
//   CREDIT
// }
