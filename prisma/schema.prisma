generator client {
  provider = "prisma-client-js"
  //output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------
// USERS
// ---------------------------------------------
model User {
  id         String   @id @default(uuid())
  fullName   String?  @db.VarChar(100)
  email      String   @unique @db.VarChar(150)
  phone      String?  @unique @db.VarChar(20)
  password   String   @db.VarChar(255)
  role       Role     @default(STUDENTS)
  isverified Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  student Student?

  Otp Otp?

  Meal Meal[]
}

model Otp {
  id         String   @id @default(uuid())
  user_id    String   @unique
  code       String   @db.VarChar(10)
  expires_at DateTime
  created_at DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// ---------------------------------------------
// STUDENTS
// ---------------------------------------------
model Student {
  id              String     @id @default(uuid())
  user_id         String     @unique
  registration_no String     @unique @db.VarChar(50)
  faculty         String?    @db.VarChar(100)
  meal_status     MealStatus @default(ACTIVE)
  balance         Decimal?   @default(0.00) @db.Decimal(10, 2)
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  // Relations
  user           User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mealAccessLogs MealAccessLog[]
  bookings       MealBooking[]
  payments       Payment[]
  transactions   Transaction[]
}

// ---------------------------------------------
// MEALS
// ---------------------------------------------
model Meal {
  id         String     @id @default(uuid())
  user_id    String
  meal_type  MealType
  status     MealStatus @default(ACTIVE)
  price      Decimal    @default(0.00) @db.Decimal(10, 2)
  created_at DateTime   @default(now())
  updated_at DateTime   @default(now())

  // Relations
  mealAccessLogs MealAccessLog[]
  user           User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transactions   Transaction[]
}

// ---------------------------------------------
// MEAL ACCESS LOGS
// ---------------------------------------------
model MealAccessLog {
  id          String       @id @default(uuid())
  student_id  String
  meal_id     String
  booking_id  String?
  access_time DateTime     @default(now())
  status      AccessStatus @default(VALID)

  // Relations
  student Student      @relation(fields: [student_id], references: [id], onDelete: Cascade)
  meal    Meal         @relation(fields: [meal_id], references: [id], onDelete: Cascade)
  booking MealBooking? @relation(fields: [booking_id], references: [id], onDelete: Cascade)
}

// ---------------------------------------------
// PAYMENTS
// ---------------------------------------------
model Payment {
  id            String        @id @default(uuid())
  student_id    String
  booking_id    String?       @unique
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  provider_ref  String?       @unique
  qr_code       String?       @unique
  qr_expires_at DateTime?
  payment_date  DateTime      @default(now())
  status        PaymentStatus @default(PENDING)
  updated_at    DateTime      @updatedAt

  // Relations
  student      Student       @relation(fields: [student_id], references: [id], onDelete: Cascade)
  booking      MealBooking?  @relation("BookingPayment", fields: [booking_id], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

// ---------------------------------------------
// TRANSACTIONS
// ---------------------------------------------
model Transaction {
  id               String          @id @default(uuid())
  student_id       String
  meal_id          String?
  payment_id       String?
  booking_id       String?
  transaction_type TransactionType @default(CREDIT)
  amount           Decimal         @db.Decimal(10, 2)
  balance_after    Decimal?        @db.Decimal(10, 2)
  transaction_date DateTime        @default(now())
  remarks          String?

  // Relations
  student Student      @relation(fields: [student_id], references: [id], onDelete: Cascade)
  meal    Meal?        @relation(fields: [meal_id], references: [id], onDelete: Cascade)
  payment Payment?     @relation(fields: [payment_id], references: [id], onDelete: Cascade)
  booking MealBooking? @relation("BookingTransaction", fields: [booking_id], references: [id], onDelete: Cascade)
}

// ---------------------------------------------
// MEAL BOOKINGS
// ---------------------------------------------
model MealBooking {
  id            String        @id @default(uuid())
  student_id    String
  meal_type     MealType
  price         Decimal       @db.Decimal(10, 2)
  status        BookingStatus @default(PENDING_PAYMENT)
  scheduled_for DateTime?
  qr_code       String?       @unique
  qr_expires_at DateTime?
  created_at    DateTime      @default(now())
  updated_at    DateTime      @updatedAt

  // Relations
  student      Student         @relation(fields: [student_id], references: [id], onDelete: Cascade)
  payment      Payment?        @relation("BookingPayment")
  transactions Transaction[]   @relation("BookingTransaction")
  mealAccesses MealAccessLog[]
}

// ---------------------------------------------
// RESTAURANT METRICS
// ---------------------------------------------
model RestaurantMetric {
  id           String   @id @default("main")
  totalRevenue Decimal  @default(0.00) @db.Decimal(14, 2)
  totalTopUps  Decimal  @default(0.00) @db.Decimal(14, 2)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
}

// ---------------------------------------------
// ENUMS
// ---------------------------------------------
enum Role {
  STUDENTS
  STAFF
  SUPERADMIN
  ADMIN
}

enum MealStatus {
  ACTIVE
  INACTIVE
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  LUNCH_DINNER
}

enum TimeSlot {
  MORNING
  AFTERNOON
  EVENING
}

enum AccessStatus {
  VALID
  INVALID
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  CARD
  BANK_TRANSIFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum BookingStatus {
  PENDING_PAYMENT
  PAID
  CONSUMED
  CANCELLED
}
